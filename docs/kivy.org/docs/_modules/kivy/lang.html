<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  
<!-- Mirrored from kivy.org/docs/_modules/kivy/lang.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jan 2015 07:56:35 GMT -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="twitter:site" content="@kivyframework">
    
    <title>kivy.lang &mdash; Kivy 1.9.0-dev documentation</title>
    <link href='../../../../fonts.googleapis.com/css8da2.css?family=Source+Code+Pro:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../../_static/fresh.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.9.0-dev',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../cdn.mathjax.org/mathjax/latest/MathJaxdda6.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/jquery-effects-core-and-slide.js"></script>
    <script type="text/javascript" src="../../_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../_static/kivy.js"></script>
    <link rel="top" title="Kivy 1.9.0-dev documentation" href="../../index-2.html" />
    <link rel="up" title="kivy" href="../kivy.html" /> 
  </head>
  <body>

    <div id="topbar">
        <div id="topwrapper">
        <div id="toplogo">
            <a href="http://kivy.org/">
                <img src="../../_static/logo-kivy.png" alt="Kivy" height="50"/>
            </a>
        </div>
        <div id="topmenu">
            <ul class="navigation">
                <li><a class="nav-guides" href="../../gettingstarted/intro.html">Guides</a></li>
                <li><a class="nav-garden" href="http://kivy-garden.github.io/">Garden</a></li>
                <li><a class="nav-api" href="../../api-kivy.html">API Reference</a></li>
                <li><a class="nav-pdf" href="../../pdf/Kivy-latest.pdf">PDF</a></li>
                <li><a class="nav-wiki" href="http://wiki.kivy.org/">Wiki</a></li>
            </ul>
        </div>
        </div>
    </div>
<div id="contentall">
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3>Quick search</h3>
            <form class="search" action="http://kivy.org/docs/search.html" method="get">
                &nbsp;
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                <input type="text" class="text" name="q" />
            </form>
          <!--
          <h3><a href="../../index.html">kivy.lang</a></h3>
          
          <h3><a href="../../index.html">Table Of Contents</a></h3>
          -->
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/index.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/first_app.html">A first App</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/properties.html">Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/rules.html">Kv Design Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/events.html">Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/framework.html">Non-widget stuff</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/layouts.html">Layouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/drawing.html">Drawing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/packaging.html">Packaging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/examples.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../gettingstarted/diving.html">Diving in</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user-guide.html">User&#8217;s Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../philosophy.html">Philosophy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute.html">Contributing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq.html">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contact.html">Contact Us</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guide-index.html">Programming Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/basic.html">Kivy Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/environment.html">Controlling the environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/config.html">Configure Kivy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/architecture.html">Architectural Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/events.html">Events and Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/inputs.html">Input management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/widgets.html">Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/graphics.html">Graphics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/lang.html">Kv language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/other-frameworks.html">Integrating with other Frameworks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/bestpractices.html">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/advancedgraphics.html">Advanced Graphics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/packaging.html">Packaging your application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials-index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/pong.html">Pong Game Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/firstwidget.html">A Simple Paint App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api-index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.html">Kivy framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.html">Adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.adapter.html">Adapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.args_converters.html">List Item View Argument Converters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.dictadapter.html">DictAdapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.listadapter.html">ListAdapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.models.html">SelectableDataItem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.adapters.simplelistadapter.html">SimpleListAdapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.animation.html">Animation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.app.html">Application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.atlas.html">Atlas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.base.html">Kivy Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.cache.html">Cache manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.clock.html">Clock object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.compat.html">Compatibility module for Python 2.7 and &gt; 3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.config.html">Configuration object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.context.html">Context</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.html">Core Abstraction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.audio.html">Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.clipboard.html">Clipboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.gl.html">OpenGL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.image.html">Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.spelling.html">Spelling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.text.html">Text</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.text.markup.html">Text Markup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.text.text_layout.html">Text layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.video.html">Video</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.core.window.html">Window</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.effects.html">Effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.effects.dampedscroll.html">Damped scroll effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.effects.kinetic.html">Kinetic effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.effects.opacityscroll.html">Opacity scroll effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.effects.scroll.html">Scroll effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.event.html">Event dispatcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.ext.html">Extension Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.factory.html">Factory object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.garden.html">Garden</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.geometry.html">Geometry utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.gesture.html">Gesture recognition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.html">Graphics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.compiler.html">Graphics compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.context.html">Context management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.context_instructions.html">Context instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.fbo.html">Framebuffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.gl_instructions.html">GL instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.instructions.html">Canvas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.opengl.html">OpenGL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.opengl_utils.html">OpenGL utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.shader.html">Shader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.stencil_instructions.html">Stencil instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.svg.html">SVG</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.tesselator.html">Tesselator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.texture.html">Texture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.graphics.transformation.html">Transformation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.html">Input management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.factory.html">Motion Event Factory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.motionevent.html">Motion Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.html">Input Postprocessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.calibration.html">Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.dejitter.html">Dejitter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.doubletap.html">Double Tap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.ignorelist.html">Ignore list</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.retaintouch.html">Retain Touch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.postproc.tripletap.html">Triple Tap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.provider.html">Motion Event Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.html">Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.androidjoystick.html">Android Joystick Input Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.hidinput.html">Native support for HID input from the linux kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.leapfinger.html">Leap Motion - finger only</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.linuxwacom.html">Native support of Wacom tablet from linuxwacom driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.mactouch.html">Native support of MultitouchSupport framework for MacBook (MaxOSX platform)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.mouse.html">Mouse provider implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.mtdev.html">Native support for Multitouch devices on Linux, using libmtdev.</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.probesysfs.html">Auto Create Input Provider Config Entry for Available MT Hardware (linux only).</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.tuio.html">TUIO Input Provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.wm_common.html">Common definitions for a Windows provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.wm_pen.html">Support for WM_PEN messages (Windows platform)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.providers.wm_touch.html">Support for WM_TOUCH messages (Windows platform)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.recorder.html">Input recorder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.input.shape.html">Motion Event Shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.interactive.html">Interactive launcher</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.lang.html">Kivy Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.lib.html">External libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.lib.gstplayer.html">GstPlayer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.loader.html">Asynchronous data loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.logger.html">Logger object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.metrics.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.inspector.html">Inspector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.keybinding.html">Keybinding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.monitor.html">Monitor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.recorder.html">Recorder module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.screen.html">Screen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.touchring.html">Touchring</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.modules.webdebugger.html">Web Debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.multistroke.html">Multistroke gesture recognizer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.network.html">Network support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.network.urlrequest.html">Url Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.parser.html">Parser utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.properties.html">Properties</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.resources.html">Resources management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.storage.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.storage.dictstore.html">Dictionary store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.storage.jsonstore.html">JSON store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.storage.redisstore.html">Redis Store</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.support.html">Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.html">Widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.abstractview.html">Abstract View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.accordion.html">Accordion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.actionbar.html">Action Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.anchorlayout.html">Anchor Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.behaviors.html">Behaviors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.boxlayout.html">Box Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.bubble.html">Bubble</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.button.html">Button</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.camera.html">Camera</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.carousel.html">Carousel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.checkbox.html">CheckBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.codeinput.html">Code Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.colorpicker.html">Color Picker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.dropdown.html">Drop-Down List</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.effectwidget.html">EffectWidget</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.filechooser.html">FileChooser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.floatlayout.html">Float Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.gesturesurface.html">Gesture Surface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.gridlayout.html">Grid Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.image.html">Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.label.html">Label</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.layout.html">Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.listview.html">List View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.modalview.html">ModalView</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.pagelayout.html">PageLayout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.popup.html">Popup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.progressbar.html">Progress Bar</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.relativelayout.html">Relative Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.rst.html">reStructuredText renderer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.sandbox.html">Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.scatter.html">Scatter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.scatterlayout.html">Scatter Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.screenmanager.html">Screen Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.scrollview.html">Scroll View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.settings.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.slider.html">Slider</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.spinner.html">Spinner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.splitter.html">Splitter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.stacklayout.html">Stack Layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.stencilview.html">Stencil View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.switch.html">Switch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.tabbedpanel.html">TabbedPanel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.textinput.html">Text Input</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.togglebutton.html">Toggle button</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.treeview.html">Tree View</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.video.html">Video</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.videoplayer.html">Video player</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.vkeyboard.html">VKeyboard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.uix.widget.html">Widget class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.utils.html">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.vector.html">Vector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../api-kivy.weakmethod.html">Weak Method</a></li>
</ul>
</li>
</ul>

          <!--
          <h3>Related Topics</h3>
          <ul>
          </ul>
          -->
        </div>
      </div>
    <div id="content">
    <div class="wrapper">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            <div class="toc"><h2>Table Of Contents</h2></div>
            
  <h1>Source code for kivy.lang</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;Kivy Language</span>
<span class="sd">=============</span>

<span class="sd">The Kivy language is a language dedicated to describing user interface and</span>
<span class="sd">interactions. You could compare this language to Qt&#39;s QML</span>
<span class="sd">(http://qt.nokia.com), but we included new concepts such as rule definitions</span>
<span class="sd">(which are somewhat akin to what you may know from CSS), templating and so on.</span>

<span class="sd">.. versionchanged:: 1.7.0</span>

<span class="sd">    The Builder doesn&#39;t execute canvas expressions in realtime anymore. It will</span>
<span class="sd">    pack all the expressions that need to be executed first and execute them</span>
<span class="sd">    after dispatching input, just before drawing the frame. If you want to</span>
<span class="sd">    force the execution of canvas drawing, just call</span>
<span class="sd">    :meth:`Builder.sync &lt;BuilderBase.sync&gt;`.</span>

<span class="sd">    An experimental profiling tool for the kv lang is also included. You can</span>
<span class="sd">    activate it by setting the environment variable `KIVY_PROFILE_LANG=1`.</span>
<span class="sd">    It will then generate an html file named `builder_stats.html`.</span>

<span class="sd">Overview</span>
<span class="sd">--------</span>

<span class="sd">The language consists of several constructs that you can use:</span>

<span class="sd">    Rules</span>
<span class="sd">        A rule is similar to a CSS rule. A rule applies to specific widgets (or</span>
<span class="sd">        classes thereof) in your widget tree and modifies them in a</span>
<span class="sd">        certain way.</span>
<span class="sd">        You can use rules to specify interactive behaviour or use them to add</span>
<span class="sd">        graphical representations of the widgets they apply to.</span>
<span class="sd">        You can target a specific class of widgets (similar to the CSS</span>
<span class="sd">        concept of a *class*) by using the ``cls`` attribute (e.g.</span>
<span class="sd">        ``cls=MyTestWidget``).</span>

<span class="sd">    A Root Widget</span>
<span class="sd">        You can use the language to create your entire user interface.</span>
<span class="sd">        A kv file must contain only one root widget at most.</span>

<span class="sd">    Dynamic Classes</span>
<span class="sd">        *(introduced in version 1.7.0)*</span>
<span class="sd">        Dynamic classes let you create new widgets and rules on-the-fly,</span>
<span class="sd">        without any Python declaration.</span>

<span class="sd">    Templates (deprecated)</span>
<span class="sd">        *(introduced in version 1.0.5, deprecated from version 1.7.0)*</span>
<span class="sd">        Templates were used to populate parts of an application, such as</span>
<span class="sd">        styling the content of a list (e.g. icon on the left, text on the</span>
<span class="sd">        right). They are now deprecated by dynamic classes.</span>


<span class="sd">Syntax of a kv File</span>
<span class="sd">-------------------</span>

<span class="sd">.. highlight:: kv</span>

<span class="sd">A Kivy language file must have ``.kv`` as filename extension.</span>

<span class="sd">The content of the file should always start with the Kivy header, where</span>
<span class="sd">`version` must be replaced with the Kivy language version you&#39;re using.</span>
<span class="sd">For now, use 1.0::</span>

<span class="sd">    #:kivy `1.0`</span>

<span class="sd">    # content here</span>

<span class="sd">The `content` can contain rule definitions, a root widget, dynamic class</span>
<span class="sd">definitions and templates::</span>

<span class="sd">    # Syntax of a rule definition. Note that several Rules can share the same</span>
<span class="sd">    # definition (as in CSS). Note the braces: they are part of the definition.</span>
<span class="sd">    &lt;Rule1,Rule2&gt;:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">    &lt;Rule3&gt;:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">    # Syntax for creating a root widget</span>
<span class="sd">    RootClassName:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">    # Syntax for creating a dynamic class</span>
<span class="sd">    &lt;NewWidget@BaseClass&gt;:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">    # Syntax for create a template</span>
<span class="sd">    [TemplateName@BaseClass1,BaseClass2]:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">Regardless of whether it&#39;s a rule, root widget, dynamic class or</span>
<span class="sd">template you&#39;re defining, the definition should look like this::</span>

<span class="sd">    # With the braces it&#39;s a rule. Without them, it&#39;s a root widget.</span>
<span class="sd">    &lt;ClassName&gt;:</span>
<span class="sd">        prop1: value1</span>
<span class="sd">        prop2: value2</span>

<span class="sd">        canvas:</span>
<span class="sd">            CanvasInstruction1:</span>
<span class="sd">                canvasprop1: value1</span>
<span class="sd">            CanvasInstruction2:</span>
<span class="sd">                canvasprop2: value2</span>

<span class="sd">        AnotherClass:</span>
<span class="sd">            prop3: value1</span>

<span class="sd">Here `prop1` and `prop2` are the properties of `ClassName` and `prop3` is the</span>
<span class="sd">property of `AnotherClass`. If the widget doesn&#39;t have a property with</span>
<span class="sd">the given name, an :class:`~kivy.properties.ObjectProperty` will be</span>
<span class="sd">automatically created and added to the instance.</span>

<span class="sd">`AnotherClass` will be created and added as a child of the `ClassName`</span>
<span class="sd">instance.</span>

<span class="sd">- The indentation is important and must be consistent. The spacing must be a</span>
<span class="sd">  multiple of the number of spaces used on the first indented line. Spaces</span>
<span class="sd">  are encouraged: mixing tabs and spaces is not recommended.</span>
<span class="sd">- The value of a property must be given on a single line (for now at least).</span>
<span class="sd">- The `canvas` property is special: you can put graphics instructions in it</span>
<span class="sd">  to create a graphical representation of the current class.</span>


<span class="sd">Here is a simple example of a kv file that contains a root widget::</span>

<span class="sd">    #:kivy 1.0</span>

<span class="sd">    Button:</span>
<span class="sd">        text: &#39;Hello world&#39;</span>


<span class="sd">.. versionchanged:: 1.7.0</span>

<span class="sd">    The indentation is not limited to 4 spaces anymore. The spacing must be a</span>
<span class="sd">    multiple of the number of spaces used on the first indented line.</span>

<span class="sd">Both the :meth:`~BuilderBase.load_file` and the</span>
<span class="sd">:meth:`~BuilderBase.load_string` methods</span>
<span class="sd">return the root widget defined in your kv file/string. They will also add any</span>
<span class="sd">class and template definitions to the :class:`~kivy.factory.Factory` for later</span>
<span class="sd">usage.</span>

<span class="sd">Value Expressions, on_property Expressions, ids and Reserved Keywords</span>
<span class="sd">---------------------------------------------------------------------</span>

<span class="sd">When you specify a property&#39;s value, the value is evaluated as a Python</span>
<span class="sd">expression. This expression can be static or dynamic, which means that</span>
<span class="sd">the value can use the values of other properties using reserved keywords.</span>

<span class="sd">    self</span>
<span class="sd">        The keyword self references the &quot;current widget instance&quot;::</span>

<span class="sd">            Button:</span>
<span class="sd">                text: &#39;My state is %s&#39; % self.state</span>

<span class="sd">    root</span>
<span class="sd">        This keyword is available only in rule definitions and represents the</span>
<span class="sd">        root widget of the rule (the first instance of the rule)::</span>

<span class="sd">            &lt;MyWidget&gt;:</span>
<span class="sd">                custom: &#39;Hello world&#39;</span>
<span class="sd">                Button:</span>
<span class="sd">                    text: root.custom</span>

<span class="sd">    app</span>
<span class="sd">        This keyword always refers to your app instance. It&#39;s equivalent</span>
<span class="sd">        to a call to :meth:`kivy.app.App.get_running_app` in Python.::</span>

<span class="sd">            Label:</span>
<span class="sd">                text: app.name</span>

<span class="sd">    args</span>
<span class="sd">        This keyword is available in on_&lt;action&gt; callbacks. It refers to the</span>
<span class="sd">        arguments passed to the callback.::</span>

<span class="sd">            TextInput:</span>
<span class="sd">                on_focus: self.insert_text(&quot;Focus&quot; if args[1] else &quot;No focus&quot;)</span>

<span class="sd">ids</span>
<span class="sd">~~~</span>

<span class="sd">Class definitions may contain ids which can be used as a keywords:::</span>

<span class="sd">    &lt;MyWidget&gt;:</span>
<span class="sd">        Button:</span>
<span class="sd">            id: btn1</span>
<span class="sd">        Button:</span>
<span class="sd">            text: &#39;The state of the other button is %s&#39; % btn1.state</span>

<span class="sd">Please note that the `id` will not be available in the widget instance:</span>
<span class="sd">it is used exclusively for external references. `id` is a weakref to the</span>
<span class="sd">widget, and not the widget itself. The widget itself can be accessed</span>
<span class="sd">with `id.__self__` (`btn1.__self__` in this case).</span>

<span class="sd">When the kv file is processed, weakrefs to all the widgets tagged with ids are</span>
<span class="sd">added to the root widgets `ids` dictionary. In other words, following on from</span>
<span class="sd">the example above, the buttons state could also be accessed as follows:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    widget = MyWidget()</span>
<span class="sd">    state = widget.ids[&quot;btn1&quot;].state</span>

<span class="sd">    # Or, as an alternative syntax,</span>
<span class="sd">    state = widget.ids.btn1.state</span>

<span class="sd">Note that the outermost widget applies the kv rules to all its inner widgets</span>
<span class="sd">before any other rules are applied. This means if an inner widget contains ids,</span>
<span class="sd">these ids may not be available during the inner widget&#39;s `__init__` function.</span>

<span class="sd">Valid expressons</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">There are two places that accept python statments in a kv file:</span>
<span class="sd">after a property, which assigns to the property the result of the expression</span>
<span class="sd">(such as the text of a button as shown above) and after a on_property, which</span>
<span class="sd">executes the statement when the property is updated (such as on_state).</span>

<span class="sd">In the former case, the</span>
<span class="sd">`expression &lt;http://docs.python.org/2/reference/expressions.html&gt;`_ can only</span>
<span class="sd">span a single line, cannot be extended to multiple lines using newline</span>
<span class="sd">escaping, and must return a value. An example of a valid expression is</span>
<span class="sd">``text: self.state and (&#39;up&#39; if self.state == &#39;normal&#39; else &#39;down&#39;)``.</span>

<span class="sd">In the latter case, multiple single line statements are valid including</span>
<span class="sd">multi-line statements that escape their newline, as long as they don&#39;t</span>
<span class="sd">add an indentation level.</span>

<span class="sd">Examples of valid statements are:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    on_press: if self.state == &#39;normal&#39;: print(&#39;normal&#39;)</span>
<span class="sd">    on_state:</span>
<span class="sd">        if self.state == &#39;normal&#39;: print(&#39;normal&#39;)</span>
<span class="sd">        else: print(&#39;down&#39;)</span>
<span class="sd">        if self.state == &#39;normal&#39;: \\</span>
<span class="sd">        print(&#39;multiline normal&#39;)</span>
<span class="sd">        for i in range(10): print(i)</span>
<span class="sd">        print([1,2,3,4,</span>
<span class="sd">        5,6,7])</span>

<span class="sd">An example of a invalid statement:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    on_state:</span>
<span class="sd">        if self.state == &#39;normal&#39;:</span>
<span class="sd">            print(&#39;normal&#39;)</span>

<span class="sd">Relation Between Values and Properties</span>
<span class="sd">--------------------------------------</span>

<span class="sd">When you use the Kivy language, you might notice that we do some work</span>
<span class="sd">behind the scenes to automatically make things work properly. You should</span>
<span class="sd">know that :doc:`api-kivy.properties` implement the</span>
<span class="sd">`Observer Design Pattern &lt;http://en.wikipedia.org/wiki/Observer_pattern&gt;`_.</span>
<span class="sd">That means that you can bind your own function to be</span>
<span class="sd">called when the value of a property changes (i.e. you passively</span>
<span class="sd">`observe` the property for potential changes).</span>

<span class="sd">The Kivy language detects properties in your `value` expression and will create</span>
<span class="sd">create callbacks to automatically update the property via your expression when</span>
<span class="sd">changes occur.</span>

<span class="sd">Here&#39;s a simple example that demonstrates this behaviour::</span>

<span class="sd">    Button:</span>
<span class="sd">        text: str(self.state)</span>

<span class="sd">In this example, the parser detects that `self.state` is a dynamic value (a</span>
<span class="sd">property). The :attr:`~kivy.uix.button.Button.state` property of the button</span>
<span class="sd">can change at any moment (when the user touches it).</span>
<span class="sd">We now want this button to display its own state as text, even as the state</span>
<span class="sd">changes. To do this, we use the state property of the Button and use it in the</span>
<span class="sd">value expression for the button&#39;s `text` property, which controls what text is</span>
<span class="sd">displayed on the button (We also convert the state to a string representation).</span>
<span class="sd">Now, whenever the button state changes, the text property will be updated</span>
<span class="sd">automatically.</span>

<span class="sd">Remember: The value is a python expression! That means that you can do</span>
<span class="sd">something more interesting like::</span>

<span class="sd">    Button:</span>
<span class="sd">        text: &#39;Plop world&#39; if self.state == &#39;normal&#39; else &#39;Release me!&#39;</span>

<span class="sd">The Button text changes with the state of the button. By default, the button</span>
<span class="sd">text will be &#39;Plop world&#39;, but when the button is being pressed, the text will</span>
<span class="sd">change to &#39;Release me!&#39;.</span>


<span class="sd">Graphical Instructions</span>
<span class="sd">----------------------</span>

<span class="sd">The graphical instructions are a special part of the Kivy language. They are</span>
<span class="sd">handled by the &#39;canvas&#39; property definition::</span>

<span class="sd">    Widget:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: (1, 1, 1)</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                size: self.size</span>
<span class="sd">                pos: self.pos</span>

<span class="sd">All the classes added inside the canvas property must be derived from the</span>
<span class="sd">:class:`~kivy.graphics.Instruction` class. You cannot put any Widget class</span>
<span class="sd">inside the canvas property (as that would not make sense because a</span>
<span class="sd">widget is not a graphics instruction).</span>

<span class="sd">If you want to do theming, you&#39;ll have the same question as in CSS: which rules</span>
<span class="sd">have been executed first? In our case, the rules are executed</span>
<span class="sd">in processing order (i.e. top-down).</span>

<span class="sd">If you want to change how Buttons are rendered, you can create your own kv file</span>
<span class="sd">and add something like this::</span>

<span class="sd">    &lt;Button&gt;:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: (1, 0, 0)</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                pos: self.pos</span>
<span class="sd">                size: self.size</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                pos: self.pos</span>
<span class="sd">                size: self.texture_size</span>
<span class="sd">                texture: self.texture</span>

<span class="sd">This will result in buttons having a red background with the label in the</span>
<span class="sd">bottom left, in addition to all the preceding rules.</span>
<span class="sd">You can clear all the previous instructions by using the `Clear` command::</span>

<span class="sd">    &lt;Button&gt;:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Clear</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: (1, 0, 0)</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                pos: self.pos</span>
<span class="sd">                size: self.size</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                pos: self.pos</span>
<span class="sd">                size: self.texture_size</span>
<span class="sd">                texture: self.texture</span>

<span class="sd">Then, only your rules that follow the `Clear` command will be taken into</span>
<span class="sd">consideration.</span>

<span class="sd">.. _dynamic_classes:</span>

<span class="sd">Dynamic classes</span>
<span class="sd">---------------</span>

<span class="sd">Dynamic classes allow you to create new widgets on-the-fly, without any python</span>
<span class="sd">declaration in the first place. The syntax of the dynamic classes is similar to</span>
<span class="sd">the Rules, but you need to specify the base classes you want to</span>
<span class="sd">subclass.</span>

<span class="sd">The syntax looks like:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    # Simple inheritance</span>
<span class="sd">    &lt;NewWidget@Button&gt;:</span>
<span class="sd">        # kv code here ...</span>

<span class="sd">    # Multiple inheritance</span>
<span class="sd">    &lt;NewWidget@ButtonBehavior+Label&gt;:</span>
<span class="sd">        # kv code here ...</span>

<span class="sd">The `@` character is used to seperate your class name from the classes you want</span>
<span class="sd">to subclass. The Python equivalent would have been:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    # Simple inheritance</span>
<span class="sd">    class NewWidget(Button):</span>
<span class="sd">        pass</span>

<span class="sd">    # Multiple inheritance</span>
<span class="sd">    class NewWidget(ButtonBehavior, Label):</span>
<span class="sd">        pass</span>

<span class="sd">Any new properties, usually added in python code, should be declared</span>
<span class="sd">first.  If the property doesn&#39;t exist in the dynamic class, it will be</span>
<span class="sd">automatically created as an :class:`~kivy.properties.ObjectProperty`</span>
<span class="sd">(pre 1.8.0) or as an appropriate typed property (from version</span>
<span class="sd">1.8.0).</span>

<span class="sd">.. versionchanged:: 1.8.0</span>

<span class="sd">    If the property value is an expression that can be evaluated right away (no</span>
<span class="sd">    external binding), then the value will be used as default value of the</span>
<span class="sd">    property, and the type of the value will be used for the specialization of</span>
<span class="sd">    the Property class. In other terms: if you declare `hello: &quot;world&quot;`, a new</span>
<span class="sd">    :class:`~kivy.properties.StringProperty` will be instantiated, with the</span>
<span class="sd">    default value `&quot;world&quot;`. Lists, tuples, dictionaries and strings are</span>
<span class="sd">    supported.</span>

<span class="sd">Let&#39;s illustrate the usage of theses dynamic classes with an</span>
<span class="sd">implementation of a basic Image button. We could derive our classes from</span>
<span class="sd">the Button and just add a property for the image filename:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    &lt;ImageButton@Button&gt;:</span>
<span class="sd">        source: None</span>

<span class="sd">        Image:</span>
<span class="sd">            source: root.source</span>
<span class="sd">            pos: root.pos</span>
<span class="sd">            size: root.size</span>

<span class="sd">    # let&#39;s use the new classes in another rule:</span>
<span class="sd">    &lt;MainUI&gt;:</span>
<span class="sd">        BoxLayout:</span>
<span class="sd">            ImageButton:</span>
<span class="sd">                source: &#39;hello.png&#39;</span>
<span class="sd">                on_press: root.do_something()</span>
<span class="sd">            ImageButton:</span>
<span class="sd">                source: &#39;world.png&#39;</span>
<span class="sd">                on_press: root.do_something_else()</span>

<span class="sd">In Python, you can create an instance of the dynamic class as follows:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from kivy.factory import Factory</span>
<span class="sd">    button_inst = Factory.ImageButton()</span>

<span class="sd">.. note::</span>

<span class="sd">    Using dynamic classes, a child class can be declared before it&#39;s parent.</span>
<span class="sd">    This however, leads to the unintuitive situation where the parent</span>
<span class="sd">    properties/methods override those of the child. Be careful if you choose</span>
<span class="sd">    to do this.</span>

<span class="sd">.. _template_usage:</span>

<span class="sd">Templates</span>
<span class="sd">---------</span>

<span class="sd">.. versionchanged:: 1.7.0</span>

<span class="sd">    Template usage is now deprecated. Please use Dynamic classes instead.</span>

<span class="sd">Syntax of templates</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">Using a template in Kivy requires 2 things :</span>

<span class="sd">    #. a context to pass for the context (will be ctx inside template).</span>
<span class="sd">    #. a kv definition of the template.</span>

<span class="sd">Syntax of a template:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    # With only one base class</span>
<span class="sd">    [ClassName@BaseClass]:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">    # With more than one base class</span>
<span class="sd">    [ClassName@BaseClass1,BaseClass2]:</span>
<span class="sd">        # .. definitions ..</span>

<span class="sd">For example, for a list, you&#39;ll need to create a entry with a image on</span>
<span class="sd">the left, and a label on the right. You can create a template for making</span>
<span class="sd">that definition easier to use.</span>
<span class="sd">So, we&#39;ll create a template that uses 2 entries in the context: an image</span>
<span class="sd">filename and a title:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    [IconItem@BoxLayout]:</span>
<span class="sd">        Image:</span>
<span class="sd">            source: ctx.image</span>
<span class="sd">        Label:</span>
<span class="sd">            text: ctx.title</span>

<span class="sd">Then in Python, you can instantiate the template using:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from kivy.lang import Builder</span>

<span class="sd">    # create a template with hello world + an image</span>
<span class="sd">    # the context values should be passed as kwargs to the Builder.template</span>
<span class="sd">    # function</span>
<span class="sd">    icon1 = Builder.template(&#39;IconItem&#39;, title=&#39;Hello world&#39;,</span>
<span class="sd">        image=&#39;myimage.png&#39;)</span>

<span class="sd">    # create a second template with other information</span>
<span class="sd">    ctx = {&#39;title&#39;: &#39;Another hello world&#39;,</span>
<span class="sd">           &#39;image&#39;: &#39;myimage2.png&#39;}</span>
<span class="sd">    icon2 = Builder.template(&#39;IconItem&#39;, **ctx)</span>
<span class="sd">    # and use icon1 and icon2 as other widget.</span>


<span class="sd">Template example</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">Most of time, when you are creating a screen in the kv lang, you use a lot of</span>
<span class="sd">redefinitions. In our example, we&#39;ll create a Toolbar, based on a</span>
<span class="sd">BoxLayout, and put in a few :class:`~kivy.uix.image.Image` widgets that</span>
<span class="sd">will react to the *on_touch_down* event.:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    &lt;MyToolbar&gt;:</span>
<span class="sd">        BoxLayout:</span>
<span class="sd">            Image:</span>
<span class="sd">                source: &#39;data/text.png&#39;</span>
<span class="sd">                size: self.texture_size</span>
<span class="sd">                size_hint: None, None</span>
<span class="sd">                on_touch_down: self.collide_point(*args[1].pos) and\</span>
<span class="sd"> root.create_text()</span>

<span class="sd">            Image:</span>
<span class="sd">                source: &#39;data/image.png&#39;</span>
<span class="sd">                size: self.texture_size</span>
<span class="sd">                size_hint: None, None</span>
<span class="sd">                on_touch_down: self.collide_point(*args[1].pos) and\</span>
<span class="sd"> root.create_image()</span>

<span class="sd">            Image:</span>
<span class="sd">                source: &#39;data/video.png&#39;</span>
<span class="sd">                size: self.texture_size</span>
<span class="sd">                size_hint: None, None</span>
<span class="sd">                on_touch_down: self.collide_point(*args[1].pos) and\</span>
<span class="sd"> root.create_video()</span>

<span class="sd">We can see that the size and size_hint attribute are exactly the same.</span>
<span class="sd">More than that, the callback in on_touch_down and the image are changing.</span>
<span class="sd">Theses can be the variable part of the template that we can put into a context.</span>
<span class="sd">Let&#39;s try to create a template for the Image:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    [ToolbarButton@Image]:</span>

<span class="sd">        # This is the same as before</span>
<span class="sd">        size: self.texture_size</span>
<span class="sd">        size_hint: None, None</span>

<span class="sd">        # Now, we are using the ctx for the variable part of the template</span>
<span class="sd">        source: &#39;data/%s.png&#39; % ctx.image</span>
<span class="sd">        on_touch_down: self.collide_point(*args[1].pos) and ctx.callback()</span>

<span class="sd">The template can be used directly in the MyToolbar rule:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    &lt;MyToolbar&gt;:</span>
<span class="sd">        BoxLayout:</span>
<span class="sd">            ToolbarButton:</span>
<span class="sd">                image: &#39;text&#39;</span>
<span class="sd">                callback: root.create_text</span>
<span class="sd">            ToolbarButton:</span>
<span class="sd">                image: &#39;image&#39;</span>
<span class="sd">                callback: root.create_image</span>
<span class="sd">            ToolbarButton:</span>
<span class="sd">                image: &#39;video&#39;</span>
<span class="sd">                callback: root.create_video</span>

<span class="sd">That&#39;s all :)</span>


<span class="sd">Template limitations</span>
<span class="sd">~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">When you are creating a context:</span>

<span class="sd">    #. you cannot use references other than &quot;root&quot;:</span>

<span class="sd">        .. code-block:: kv</span>

<span class="sd">            &lt;MyRule&gt;:</span>
<span class="sd">                Widget:</span>
<span class="sd">                    id: mywidget</span>
<span class="sd">                    value: &#39;bleh&#39;</span>
<span class="sd">                Template:</span>
<span class="sd">                    ctxkey: mywidget.value # &lt;&lt; fail, this references the id</span>
<span class="sd">                    # mywidget</span>

<span class="sd">    #. not all of the dynamic parts will be understood:</span>

<span class="sd">        .. code-block:: kv</span>

<span class="sd">            &lt;MyRule&gt;:</span>
<span class="sd">                Template:</span>
<span class="sd">                    ctxkey: &#39;value 1&#39; if root.prop1 else &#39;value2&#39; # &lt;&lt; even if</span>
<span class="sd">                    # root.prop1 is a property, if it changes value, ctxkey</span>
<span class="sd">                    # will not be updated</span>

<span class="sd">Redefining a widget&#39;s style</span>
<span class="sd">---------------------------</span>

<span class="sd">Sometimes we would like to inherit from a widget in order to use its Python</span>
<span class="sd">properties without also using its .kv defined style. For example, we would</span>
<span class="sd">like to inherit from a Label, but we would also like to define our own</span>
<span class="sd">canvas instructions instead of automatically using the canvas instructions</span>
<span class="sd">inherited from the Label. We can achieve this by prepending a dash (-) before</span>
<span class="sd">the class name in the .kv style definition.</span>

<span class="sd">In myapp.py:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    class MyWidget(Label):</span>
<span class="sd">        pass</span>

<span class="sd">and in my.kv:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    &lt;-MyWidget&gt;:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: 1, 1, 1</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                size: (32, 32)</span>

<span class="sd">MyWidget will now have a Color and Rectangle instruction in its canvas</span>
<span class="sd">without any of the instructions inherited from the Label.</span>

<span class="sd">Lang Directives</span>
<span class="sd">---------------</span>

<span class="sd">You can use directives to add declarative commands, such as imports or constant</span>
<span class="sd">definitions, to the lang files. Directives are added as comments in the</span>
<span class="sd">following format:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:&lt;directivename&gt; &lt;options&gt;</span>

<span class="sd">import &lt;package&gt;</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">.. versionadded:: 1.0.5</span>

<span class="sd">Syntax:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:import &lt;alias&gt; &lt;package&gt;</span>

<span class="sd">You can import a package by writing:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:import os os</span>

<span class="sd">    &lt;Rule&gt;:</span>
<span class="sd">        Button:</span>
<span class="sd">            text: os.getcwd()</span>

<span class="sd">Or more complex:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:import ut kivy.utils</span>

<span class="sd">    &lt;Rule&gt;:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgba: ut.get_random_color()</span>

<span class="sd">.. versionadded:: 1.0.7</span>

<span class="sd">You can directly import classes from a module:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #: import Animation kivy.animation.Animation</span>
<span class="sd">    &lt;Rule&gt;:</span>
<span class="sd">        on_prop: Animation(x=.5).start(self)</span>

<span class="sd">set &lt;key&gt; &lt;expr&gt;</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">.. versionadded:: 1.0.6</span>

<span class="sd">Syntax:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:set &lt;key&gt; &lt;expr&gt;</span>

<span class="sd">Set a key that will be available anywhere in the kv. For example:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:set my_color (.4, .3, .4)</span>
<span class="sd">    #:set my_color_hl (.5, .4, .5)</span>

<span class="sd">    &lt;Rule&gt;:</span>
<span class="sd">        state: &#39;normal&#39;</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: my_color if self.state == &#39;normal&#39; else my_color_hl</span>

<span class="sd">include &lt;file&gt;</span>
<span class="sd">~~~~~~~~~~~~~~~~</span>

<span class="sd">.. versionadded:: 1.9.0</span>

<span class="sd">Syntax:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    #:include [force] &lt;file&gt;</span>

<span class="sd">Includes an external kivy file. This allows you to split complex</span>
<span class="sd">widgets into their own files. If the include is forced, the file</span>
<span class="sd">will first be unloaded and then reloaded again. For example:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    # Test.kv</span>
<span class="sd">    #:include mycomponent.kv</span>
<span class="sd">    #:include force mybutton.kv</span>

<span class="sd">    &lt;Rule&gt;:</span>
<span class="sd">        state: &#39;normal&#39;</span>
<span class="sd">        MyButton:</span>
<span class="sd">        MyComponent:</span>


<span class="sd">.. code-block:: kv</span>

<span class="sd">    # mycomponent.kv</span>
<span class="sd">    #:include mybutton.kv</span>

<span class="sd">    &lt;MyComponent&gt;:</span>
<span class="sd">        MyButton:</span>

<span class="sd">.. code-block:: kv</span>

<span class="sd">    # mybutton.kv</span>

<span class="sd">    &lt;MyButton&gt;:</span>
<span class="sd">        canvas:</span>
<span class="sd">            Color:</span>
<span class="sd">                rgb: (1.0, 0.0, 0.0)</span>
<span class="sd">            Rectangle:</span>
<span class="sd">                pos: self.pos</span>
<span class="sd">                size: (self.size[0]/4, self.size[1]/4)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Observable&#39;</span><span class="p">,</span> <span class="s">&#39;Builder&#39;</span><span class="p">,</span> <span class="s">&#39;BuilderBase&#39;</span><span class="p">,</span> <span class="s">&#39;BuilderException&#39;</span><span class="p">,</span> <span class="s">&#39;Parser&#39;</span><span class="p">,</span>
           <span class="s">&#39;ParserException&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">sub</span><span class="p">,</span> <span class="n">findall</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">CodeType</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">kivy.factory</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">kivy.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">kivy.utils</span> <span class="kn">import</span> <span class="n">QueryDict</span>
<span class="kn">from</span> <span class="nn">kivy.cache</span> <span class="kn">import</span> <span class="n">Cache</span>
<span class="kn">from</span> <span class="nn">kivy</span> <span class="kn">import</span> <span class="n">kivy_data_dir</span><span class="p">,</span> <span class="n">require</span>
<span class="kn">from</span> <span class="nn">kivy.compat</span> <span class="kn">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">iterkeys</span>
<span class="kn">from</span> <span class="nn">kivy.context</span> <span class="kn">import</span> <span class="n">register_context</span>
<span class="kn">from</span> <span class="nn">kivy.resources</span> <span class="kn">import</span> <span class="n">resource_find</span>
<span class="kn">import</span> <span class="nn">kivy.metrics</span> <span class="kn">as</span> <span class="nn">Metrics</span>
<span class="kn">from</span> <span class="nn">kivy._event</span> <span class="kn">import</span> <span class="n">Observable</span><span class="p">,</span> <span class="n">EventDispatcher</span>


<span class="n">trace</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="n">trace</span>
<span class="n">global_idmap</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c"># late import</span>
<span class="n">Instruction</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># register cache for creating new classtype (template)</span>
<span class="n">Cache</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&#39;kv.lang&#39;</span><span class="p">)</span>

<span class="c"># all previously included files</span>
<span class="n">__KV_INCLUDES__</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c"># precompile regexp expression</span>
<span class="n">lang_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;([</span><span class="se">\&#39;</span><span class="s">&quot;][^</span><span class="se">\&#39;</span><span class="s">&quot;]*[</span><span class="se">\&#39;</span><span class="s">&quot;])&#39;</span><span class="p">)</span>
<span class="n">lang_key</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;([a-zA-Z_]+)&#39;</span><span class="p">)</span>
<span class="n">lang_keyvalue</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;([a-zA-Z_][a-zA-Z0-9_.]*\.[a-zA-Z0-9_.]+)&#39;</span><span class="p">)</span>
<span class="n">lang_tr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;(_\()&#39;</span><span class="p">)</span>


<span class="c"># all the widget handlers, used to correctly unbind all the callbacks then the</span>
<span class="c"># widget is deleted</span>
<span class="n">_handlers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ProxyApp</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c"># proxy app object</span>
    <span class="c"># taken from http://code.activestate.com/recipes/496741-object-proxying/</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_obj&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ensure_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">kivy.app</span> <span class="kn">import</span> <span class="n">App</span>
            <span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="o">.</span><span class="n">get_running_app</span><span class="p">()</span>
            <span class="nb">object</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
            <span class="c"># Clear cached application instance, when it stops</span>
            <span class="n">app</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">on_stop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">instance</span><span class="p">:</span>
                     <span class="nb">object</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">app</span>

    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="nb">delattr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_ensure_app&#39;</span><span class="p">)()</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;_obj&#39;</span><span class="p">))</span>


<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;app&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ProxyApp</span><span class="p">()</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;pt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">pt</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;inch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">inch</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;cm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">cm</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;mm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">mm</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;dp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">dp</span>
<span class="n">global_idmap</span><span class="p">[</span><span class="s">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">sp</span>


<span class="c"># delayed calls are canvas expression triggered during an loop. It is one</span>
<span class="c"># directional linked list of args to call call_fn with. Each element is a list</span>
<span class="c"># whos last element points to the next list of args to execute when</span>
<span class="c"># Builder.sync is called.</span>
<span class="n">_delayed_start</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="ParserException"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.ParserException">[docs]</a><span class="k">class</span> <span class="nc">ParserException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised when something wrong happened in a kv file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">cause</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">&#39;&lt;inline&gt;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">sourcecode</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">sourcecode</span>
        <span class="n">sc_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sc_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sourcecode</span><span class="p">),</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;...&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sc_start</span><span class="p">,</span> <span class="n">sc_stop</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">sc</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&gt;&gt; </span><span class="si">%4d</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sourcecode</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sc</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;   </span><span class="si">%4d</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sourcecode</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">sc</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;...&#39;</span><span class="p">]</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;Parser: File &quot;</span><span class="si">%s</span><span class="s">&quot;, line </span><span class="si">%d</span><span class="s">:</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cause</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">cause</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ParserException</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BuilderException"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderException">[docs]</a><span class="k">class</span> <span class="nc">BuilderException</span><span class="p">(</span><span class="n">ParserException</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Exception raised when the Builder failed to apply a rule on a widget.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">pass</span>

</div>
<span class="k">class</span> <span class="nc">ParserRuleProperty</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Represent a property inside a rule.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ctx&#39;</span><span class="p">,</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="s">&#39;co_value&#39;</span><span class="p">,</span>
                 <span class="s">&#39;watched_keys&#39;</span><span class="p">,</span> <span class="s">&#39;mode&#39;</span><span class="p">,</span> <span class="s">&#39;count&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParserRuleProperty</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c">#: Associated parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="c">#: Line of the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="c">#: Name of the property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c">#: Value of the property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c">#: Compiled value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Compilation mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Watched keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">precompile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

        <span class="c"># first, remove all the string from the value</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">lang_str</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c"># detecting how to handle the value according to the key name</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;exec&#39;</span> <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;on_&#39;</span> <span class="k">else</span> <span class="s">&#39;eval&#39;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;eval&#39;</span><span class="p">:</span>
            <span class="c"># if we don&#39;t detect any string/key in it, we can eval and give the</span>
            <span class="c"># result</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lang_key</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># ok, we can compile.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">co_value</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="ow">or</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="c"># for exec mode, we don&#39;t need to watch any keys.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;exec&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># now, detect obj.prop</span>
        <span class="c"># first, remove all the string from the value</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">lang_str</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">idx</span><span class="p">]</span>
        <span class="c"># detect key.value inside value, and split them</span>
        <span class="n">wk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">findall</span><span class="p">(</span><span class="n">lang_keyvalue</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wk</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wk</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">findall</span><span class="p">(</span><span class="n">lang_tr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">+=</span> <span class="p">[[</span><span class="s">&#39;_&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;_&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ParserRuleProperty name=</span><span class="si">%r</span><span class="s"> filename=</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s"> &#39;</span> \
               <span class="s">&#39;value=</span><span class="si">%r</span><span class="s"> watched_keys=</span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">watched_keys</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParserRule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Represents a rule, in terms of the Kivy internal language.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ctx&#39;</span><span class="p">,</span> <span class="s">&#39;line&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;children&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;properties&#39;</span><span class="p">,</span>
                 <span class="s">&#39;canvas_before&#39;</span><span class="p">,</span> <span class="s">&#39;canvas_root&#39;</span><span class="p">,</span> <span class="s">&#39;canvas_after&#39;</span><span class="p">,</span>
                 <span class="s">&#39;handlers&#39;</span><span class="p">,</span> <span class="s">&#39;level&#39;</span><span class="p">,</span> <span class="s">&#39;cache_marked&#39;</span><span class="p">,</span> <span class="s">&#39;avoid_previous_rules&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ParserRule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c">#: Level of the rule in the kv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span>
        <span class="c">#: Associated parser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span>
        <span class="c">#: Line of the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">line</span>
        <span class="c">#: Name of the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c">#: List of children to create</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#: Id given to the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Properties associated to the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="c">#: Canvas normal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_root</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Canvas before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_before</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Canvas after</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas_after</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#: Handlers associated to the rule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#: Properties cache list: mark which class have already been checked</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_marked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#: Indicate if any previous rules should be avoided.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avoid_previous_rules</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_detect_selectors</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_forbid_selectors</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">precompile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">x</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_before</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_before</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_root</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_root</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas_after</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas_after</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">create_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="c"># check first if the widget class already been processed by this rule</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_marked</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_marked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">co_value</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CodeType</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">create_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_forbid_selectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                <span class="s">&#39;Selectors rules are allowed only at the first level&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_detect_selectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_rule</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_template</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                    <span class="s">&#39;Only one root object is allowed by .kv&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">_build_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: build rule for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&lt;&#39;</span> <span class="ow">or</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                  <span class="s">&#39;Invalid rule (must be inside &lt;&gt;)&#39;</span><span class="p">)</span>

        <span class="c"># if the very first name start with a -, avoid previous rules</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avoid_previous_rules</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">rules</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="n">crule</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                      <span class="s">&#39;Empty rule detected&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
                <span class="c"># new class creation ?</span>
                <span class="c"># ensure the name is correctly written</span>
                <span class="n">rule</span><span class="p">,</span> <span class="n">baseclasses</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">lang_key</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                          <span class="s">&#39;Invalid dynamic class name&#39;</span><span class="p">)</span>

                <span class="c"># save the name in the dynamic classes dict.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">dynamic_classes</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseclasses</span>
                <span class="n">crule</span> <span class="o">=</span> <span class="n">ParserSelectorName</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># classical selectors.</span>

                <span class="k">if</span> <span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                    <span class="n">crule</span> <span class="o">=</span> <span class="n">ParserSelectorClass</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                    <span class="n">crule</span> <span class="o">=</span> <span class="n">ParserSelectorId</span><span class="p">(</span><span class="n">rule</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">crule</span> <span class="o">=</span> <span class="n">ParserSelectorName</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">crule</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_build_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: build template for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;[&#39;</span> <span class="ow">or</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;]&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                  <span class="s">&#39;Invalid template (must be inside [])&#39;</span><span class="p">)</span>
        <span class="n">item_content</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;@&#39;</span> <span class="ow">in</span> <span class="n">item_content</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                  <span class="s">&#39;Invalid template name (missing @)&#39;</span><span class="p">)</span>
        <span class="n">template_name</span><span class="p">,</span> <span class="n">template_root_cls</span> <span class="o">=</span> <span class="n">item_content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">template_name</span><span class="p">,</span> <span class="n">template_root_cls</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ParserRule name=</span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">)</span>


<div class="viewcode-block" id="Parser"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.Parser">[docs]</a><span class="k">class</span> <span class="nc">Parser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a Parser object to parse a Kivy language file or Kivy content.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">PROP_ALLOWED</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;canvas.before&#39;</span><span class="p">,</span> <span class="s">&#39;canvas.after&#39;</span><span class="p">)</span>
    <span class="n">CLASS_RANGE</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">PROP_RANGE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;Z&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
        <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">),</span> <span class="nb">ord</span><span class="p">(</span><span class="s">&#39;9&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)])</span>

    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;rules&#39;</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="s">&#39;sourcecode&#39;</span><span class="p">,</span>
                 <span class="s">&#39;directives&#39;</span><span class="p">,</span> <span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;dynamic_classes&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Parser</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcecode</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directives</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No content passed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_directives</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">__KV_INCLUDES__</span>
        <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directives</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
                <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Parser: got directive &lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;kivy &#39;</span><span class="p">:</span>
                <span class="n">version</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">version</span> <span class="o">+=</span> <span class="s">&#39;.0&#39;</span>
                <span class="n">require</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;set &#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">Logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid directive syntax&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">Logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid value&#39;</span><span class="p">)</span>
                <span class="n">global_idmap</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">elif</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;include &#39;</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">force_load</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="k">if</span> <span class="n">ref</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;force &#39;</span><span class="p">:</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">force_load</span> <span class="o">=</span> <span class="bp">True</span>

                <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s">&#39;.kv&#39;</span><span class="p">:</span>
                    <span class="n">Logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: {0} does not have a valid Kivy&#39;</span>
                                <span class="s">&#39;Language extension (.kv)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">__KV_INCLUDES__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">force_load</span><span class="p">:</span>
                        <span class="n">Logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;WARNING: {0} has already been included!&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Reloading {0} because include was forced.&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                        <span class="n">Builder</span><span class="o">.</span><span class="n">unload_file</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                        <span class="n">Builder</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid or unknown file: &#39;</span>
                                                    <span class="s">&#39;{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                <span class="n">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Including file: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">__KV_INCLUDES__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                <span class="n">Builder</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cmd</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;import &#39;</span><span class="p">:</span>
                <span class="n">package</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid import syntax&#39;</span><span class="p">)</span>
                <span class="n">alias</span><span class="p">,</span> <span class="n">package</span> <span class="o">=</span> <span class="n">l</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">package</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">package</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="c"># resolve the whole thing</span>
                        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">package</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package</span><span class="p">]</span>
                    <span class="n">global_idmap</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="n">Logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                          <span class="s">&#39;Unable to import package </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span>
                                          <span class="n">package</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Unknown directive&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Parser.parse"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.Parser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse the contents of a Parser file and return a list</span>
<span class="sd">        of root objects.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Read and parse the lines of the file</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_lines</span><span class="p">)),</span> <span class="n">lines</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcecode</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Parser: parsing </span><span class="si">%d</span><span class="s"> lines&#39;</span> <span class="o">%</span> <span class="n">num_lines</span><span class="p">)</span>

        <span class="c"># Strip all comments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strip_comments</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c"># Execute directives</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_directives</span><span class="p">()</span>

        <span class="c"># Get object from the first level</span>
        <span class="n">objects</span><span class="p">,</span> <span class="n">remaining_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_level</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

        <span class="c"># Precompile rules tree</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">precompile</span><span class="p">()</span>

        <span class="c"># After parsing, there should be no remaining lines</span>
        <span class="c"># or there&#39;s an error we did not catch earlier.</span>
        <span class="k">if</span> <span class="n">remaining_lines</span><span class="p">:</span>
            <span class="n">ln</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">remaining_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid data (not parsed)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Parser.strip_comments"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.Parser.strip_comments">[docs]</a>    <span class="k">def</span> <span class="nf">strip_comments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove all comments from all lines in-place.</span>
<span class="sd">           Comments need to be on a single line and not at the end of a line.</span>
<span class="sd">           i.e. a comment line&#39;s first non-whitespace character must be a #.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># extract directives</span>
        <span class="k">for</span> <span class="n">ln</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:]:</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stripped</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#:&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ln</span><span class="p">,</span> <span class="n">stripped</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
            <span class="k">if</span> <span class="n">stripped</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">ln</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stripped</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">ln</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Parser.parse_level"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.Parser.parse_level">[docs]</a>    <span class="k">def</span> <span class="nf">parse_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">spaces</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse the current level (level * spaces) indentation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">spaces</span> <span class="o">*</span> <span class="n">level</span> <span class="k">if</span> <span class="n">spaces</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">current_object</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">current_property</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">current_propobject</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ln</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">line</span>

            <span class="c"># Get the number of space</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="c"># Replace any tab with 4 spaces</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">content</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;    &#39;</span><span class="p">)</span>

            <span class="c"># first indent designates the indentation</span>
            <span class="k">if</span> <span class="n">spaces</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">spaces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">spaces</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">%</span> <span class="n">spaces</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                      <span class="s">&#39;Invalid indentation, &#39;</span>
                                      <span class="s">&#39;must be a multiple of &#39;</span>
                                      <span class="s">&#39;</span><span class="si">%s</span><span class="s"> spaces&#39;</span> <span class="o">%</span> <span class="n">spaces</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">rlevel</span> <span class="o">=</span> <span class="n">count</span> <span class="o">//</span> <span class="n">spaces</span> <span class="k">if</span> <span class="n">spaces</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="c"># Level finished</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">indent</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">objects</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="c"># Current level, create an object</span>
            <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="n">indent</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Identifier missing&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                          <span class="s">&#39;Invalid data after declaration&#39;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c"># if it&#39;s not a root rule, then we got some restriction</span>
                <span class="c"># aka, a valid name, without point or everything else</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">False</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="n">Parser</span><span class="o">.</span><span class="n">PROP_RANGE</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Invalid class name&#39;</span><span class="p">)</span>

                <span class="n">current_object</span> <span class="o">=</span> <span class="n">ParserRule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rlevel</span><span class="p">)</span>
                <span class="n">current_property</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_object</span><span class="p">)</span>

            <span class="c"># Next level, is it a property or an object ?</span>
            <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">spaces</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Identifier missing&#39;</span><span class="p">)</span>

                <span class="c"># It&#39;s a class, add to the current object as a children</span>
                <span class="n">current_property</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">Parser</span><span class="o">.</span><span class="n">CLASS_RANGE</span> <span class="ow">or</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">_objects</span><span class="p">,</span> <span class="n">_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_level</span><span class="p">(</span>
                        <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">spaces</span><span class="p">)</span>
                    <span class="n">current_object</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">_objects</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">_lines</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c"># It&#39;s a property</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Parser</span><span class="o">.</span><span class="n">PROP_ALLOWED</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="n">Parser</span><span class="o">.</span><span class="n">PROP_RANGE</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">name</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                                  <span class="s">&#39;Invalid property name&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Syntax error&#39;</span><span class="p">)</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="s">&#39;Empty id&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;root&#39;</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span>
                                <span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                <span class="s">&#39;Invalid id, cannot be &quot;self&quot; or &quot;root&quot;&#39;</span><span class="p">)</span>
                        <span class="n">current_object</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">rule</span> <span class="o">=</span> <span class="n">ParserRuleProperty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;on_&#39;</span><span class="p">:</span>
                            <span class="n">current_object</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current_object</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_property</span> <span class="o">=</span> <span class="n">name</span>
                        <span class="n">current_propobject</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Two more levels?</span>
            <span class="k">elif</span> <span class="n">count</span> <span class="o">==</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">spaces</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">current_property</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s">&#39;canvas&#39;</span><span class="p">,</span> <span class="s">&#39;canvas.after&#39;</span><span class="p">,</span> <span class="s">&#39;canvas.before&#39;</span><span class="p">):</span>
                    <span class="n">_objects</span><span class="p">,</span> <span class="n">_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_level</span><span class="p">(</span>
                        <span class="n">level</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span> <span class="n">spaces</span><span class="p">)</span>
                    <span class="n">rl</span> <span class="o">=</span> <span class="n">ParserRule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">current_property</span><span class="p">,</span> <span class="n">rlevel</span><span class="p">)</span>
                    <span class="n">rl</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">_objects</span>
                    <span class="k">if</span> <span class="n">current_property</span> <span class="o">==</span> <span class="s">&#39;canvas&#39;</span><span class="p">:</span>
                        <span class="n">current_object</span><span class="o">.</span><span class="n">canvas_root</span> <span class="o">=</span> <span class="n">rl</span>
                    <span class="k">elif</span> <span class="n">current_property</span> <span class="o">==</span> <span class="s">&#39;canvas.before&#39;</span><span class="p">:</span>
                        <span class="n">current_object</span><span class="o">.</span><span class="n">canvas_before</span> <span class="o">=</span> <span class="n">rl</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_object</span><span class="o">.</span><span class="n">canvas_after</span> <span class="o">=</span> <span class="n">rl</span>
                    <span class="n">current_property</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">_lines</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_propobject</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">current_propobject</span> <span class="o">=</span> <span class="n">ParserRuleProperty</span><span class="p">(</span>
                            <span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span> <span class="n">current_property</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">current_property</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;on_&#39;</span><span class="p">:</span>
                            <span class="n">current_object</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_propobject</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current_object</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="n">current_property</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">current_propobject</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">current_propobject</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">content</span>

            <span class="c"># Too much indentation, invalid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParserException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ln</span><span class="p">,</span>
                                      <span class="s">&#39;Invalid indentation (too many levels)&#39;</span><span class="p">)</span>

            <span class="c"># Check the next line</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">objects</span><span class="p">,</span> <span class="p">[]</span>

</div></div>
<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="n">widget</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">widget</span><span class="o">.</span><span class="n">proxy_ref</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">widget</span>


<span class="k">def</span> <span class="nf">custom_callback</span><span class="p">(</span><span class="n">__kvlang__</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="o">*</span><span class="n">largs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">idmap</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">largs</span>
    <span class="k">exec</span><span class="p">(</span><span class="n">__kvlang__</span><span class="o">.</span><span class="n">co_value</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">call_fn</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">idmap</span> <span class="o">=</span> <span class="n">args</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: call_fn </span><span class="si">%s</span><span class="s">, key=</span><span class="si">%s</span><span class="s">, value=</span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
    <span class="n">rule</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">e_value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
        <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: call_fn =&gt; value=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e_value</span><span class="p">,</span> <span class="p">))</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">e_value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">delayed_call_fn</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
    <span class="c"># it&#39;s already on the list</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">global</span> <span class="n">_delayed_start</span>
    <span class="k">if</span> <span class="n">_delayed_start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">_delayed_start</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="ne">StopIteration</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">_delayed_start</span>
        <span class="n">_delayed_start</span> <span class="o">=</span> <span class="n">args</span>


<span class="k">def</span> <span class="nf">update_intermediates</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Function that is called when an intermediate property is updated</span>
<span class="sd">    and `rebind` of that property is True. In that case, we unbind</span>
<span class="sd">    all bound funcs that were bound to attrs of the old value of the</span>
<span class="sd">    property and rebind to the new value of the property.</span>

<span class="sd">    For example, if the rule is `self.a.b.c.d`, then when b is changed, we</span>
<span class="sd">    unbind from `b`, `c` and `d`, if they were bound before (they were not</span>
<span class="sd">    None and `rebind` of the respective properties was True) and we rebind</span>
<span class="sd">    to the new values of the attrs `b`, `c``, `d` that are not None and</span>
<span class="sd">    `rebind` is True.</span>

<span class="sd">    :Parameters:</span>
<span class="sd">        `base`</span>
<span class="sd">            A (proxied) ref to the base widget, `self` in the example</span>
<span class="sd">            above.</span>
<span class="sd">        `keys`</span>
<span class="sd">            A list of the name off the attrs of `base` being watched. In</span>
<span class="sd">            the example above it&#39;d be `[&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;]`.</span>
<span class="sd">        `bound`</span>
<span class="sd">            A list 3-tuples, each tuple being (widget, attr, callback)</span>
<span class="sd">            representing callback functions bound to the attributed `attr`</span>
<span class="sd">            of `widget`. The callback maybe be None, in which case the attr</span>
<span class="sd">            was not bound, but is there to be able to walk the attr tree.</span>
<span class="sd">            E.g. in the example above, if `b` was not an eventdispatcher,</span>
<span class="sd">            `(_b_ref_, `c`, None)` would be added to the list so we can get</span>
<span class="sd">            to `c` and `d`, which may be eventdispatchers and their attrs.</span>
<span class="sd">        `s`</span>
<span class="sd">            The index in `keys` of the of the attr that needs to be</span>
<span class="sd">            updated. That is all the keys from `s` and further will be</span>
<span class="sd">            rebound, since the `s` key was changed. In bound, the</span>
<span class="sd">            corresponding index is `s - 1`. If `s` is None, we start from</span>
<span class="sd">            1 (first attr).</span>
<span class="sd">        `fn`</span>
<span class="sd">            The function to be called args, `args` on bound callback.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># first remove all the old bound functions from `s` and down.</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">largs</span> <span class="ow">in</span> <span class="n">bound</span><span class="p">[</span><span class="n">j</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">fun</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">fast_unbind</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="o">*</span><span class="n">largs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">del</span> <span class="n">bound</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>

    <span class="c"># find the first attr from which we need to start rebinding.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bound</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">bound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c"># if it&#39;s the very first attr, we start with the base.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">base</span>
    <span class="n">append</span> <span class="o">=</span> <span class="n">bound</span><span class="o">.</span><span class="n">append</span>

    <span class="c"># bind all attrs, except last to update_intermediates</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c"># if we need to dynamically rebind, bindm otherwise just</span>
        <span class="c"># add the attr to the list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">EventDispatcher</span><span class="p">,</span> <span class="n">Observable</span><span class="p">)):</span>
            <span class="n">prop</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;rebind&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="c"># fast_bind should not dispatch, otherwise</span>
                <span class="c"># update_intermediates might be called in the middle</span>
                <span class="c"># here messing things up</span>
                <span class="n">f</span><span class="o">.</span><span class="n">fast_bind</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">update_intermediates</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
                            <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">update_intermediates</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">()])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">append</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;proxy_ref&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">()])</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c"># for the last attr we bind directly to the setting function,</span>
    <span class="c"># because that attr sets the value of the rule.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">EventDispatcher</span><span class="p">,</span> <span class="n">Observable</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">fast_bind</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">)])</span>
    <span class="c"># when we rebind we have to update the</span>
    <span class="c"># rule with the most recent value, otherwise, the value might be wrong</span>
    <span class="c"># and wouldn&#39;t be updated since we might not have tracked it before.</span>
    <span class="c"># This only happens for a callback when rebind was True for the prop.</span>
    <span class="n">fn</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_handler</span><span class="p">(</span><span class="n">iself</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="n">delayed</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">idmap</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">idmap</span><span class="p">)</span>
    <span class="n">idmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">global_idmap</span><span class="p">)</span>
    <span class="n">idmap</span><span class="p">[</span><span class="s">&#39;self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iself</span><span class="o">.</span><span class="n">proxy_ref</span>
    <span class="n">handler_append</span> <span class="o">=</span> <span class="n">_handlers</span><span class="p">[</span><span class="n">iself</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span>

    <span class="c"># we need a hash for when delayed, so we don&#39;t execute duplicate canvas</span>
    <span class="c"># callbacks from the same handler during a sync op</span>
    <span class="k">if</span> <span class="n">delayed</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">delayed_call_fn</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>  <span class="c"># see _delayed_start</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">call_fn</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>

    <span class="c"># bind every key.value</span>
    <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">watched_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">watched_keys</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">idmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">base</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&#39;proxy_ref&#39;</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
            <span class="n">bound</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">was_bound</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">bound</span><span class="o">.</span><span class="n">append</span>

            <span class="c"># bind all attrs, except last to update_intermediates</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c"># if we need to dynamically rebind, bindm otherwise</span>
                <span class="c"># just add the attr to the list</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">EventDispatcher</span><span class="p">,</span> <span class="n">Observable</span><span class="p">)):</span>
                    <span class="n">prop</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s">&#39;rebind&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                        <span class="c"># fast_bind should not dispatch, otherwise</span>
                        <span class="c"># update_intermediates might be called in the middle</span>
                        <span class="c"># here messing things up</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">fast_bind</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">update_intermediates</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span>
                                    <span class="n">bound</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">update_intermediates</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">)])</span>
                        <span class="n">was_bound</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">()])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">append</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;proxy_ref&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">()])</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># for the last attr we bind directly to the setting</span>
            <span class="c"># function, because that attr sets the value of the rule.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">EventDispatcher</span><span class="p">,</span> <span class="n">Observable</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">fast_bind</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>  <span class="c"># f is not None</span>
                    <span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">)])</span>
                    <span class="n">was_bound</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">was_bound</span><span class="p">:</span>
                <span class="n">handler_append</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                               <span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span>
                               <span class="n">cause</span><span class="o">=</span><span class="n">tb</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParserSelector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s"> key=</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParserSelectorId</span><span class="p">(</span><span class="n">ParserSelector</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">widget</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">widget</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span>


<span class="k">class</span> <span class="nc">ParserSelectorClass</span><span class="p">(</span><span class="n">ParserSelector</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">widget</span><span class="o">.</span><span class="n">cls</span>


<span class="k">class</span> <span class="nc">ParserSelectorName</span><span class="p">(</span><span class="n">ParserSelector</span><span class="p">):</span>

    <span class="n">parents</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_bases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__bases__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">yield</span> <span class="n">base</span>
            <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;Widget&#39;</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">cbase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bases</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">cbase</span>

    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">ParserSelectorName</span><span class="o">.</span><span class="n">parents</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">__class__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                       <span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_bases</span><span class="p">(</span><span class="n">cls</span><span class="p">))]</span>
            <span class="n">parents</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">classes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">[</span><span class="n">cls</span><span class="p">]</span>


<div class="viewcode-block" id="BuilderBase"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase">[docs]</a><span class="k">class</span> <span class="nc">BuilderBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;The Builder is responsible for creating a :class:`Parser` for parsing a</span>
<span class="sd">    kv file, merging the results into its internal rules, templates, etc.</span>

<span class="sd">    By default, :class:`Builder` is a global Kivy instance used in widgets</span>
<span class="sd">    that you can use to load other kv files in addition to the default ones.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_cache_match</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BuilderBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_classes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="BuilderBase.load_file"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.load_file">[docs]</a>    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Insert a file into the language builder and return the root widget</span>
<span class="sd">        (if defined) of the kv file.</span>

<span class="sd">        :parameters:</span>
<span class="sd">            `rulesonly`: bool, defaults to False</span>
<span class="sd">                If True, the Builder will raise an exception if you have a root</span>
<span class="sd">                widget inside the definition.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">resource_find</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: load file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="c"># remove bom ?</span>
            <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF16_LE</span><span class="p">,</span> <span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF16_BE</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unsupported UTF16 for kv files.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF32_LE</span><span class="p">,</span> <span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF32_BE</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unsupported UTF32 for kv files.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF8</span><span class="p">):</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">BOM_UTF8</span><span class="p">):]</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_string</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BuilderBase.unload_file"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.unload_file">[docs]</a>    <span class="k">def</span> <span class="nf">unload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Unload all rules associated with a previously imported file.</span>

<span class="sd">        .. versionadded:: 1.0.8</span>

<span class="sd">        .. warning::</span>

<span class="sd">            This will not remove rules or templates already applied/used on</span>
<span class="sd">            current widgets. It will only effect the next widgets creation or</span>
<span class="sd">            template invocation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># remove rules and templates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_matchcache</span><span class="p">()</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">templates</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates</span> <span class="o">=</span> <span class="n">templates</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># unregister all the dynamic classes</span>
        <span class="n">Factory</span><span class="o">.</span><span class="n">unregister_from_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="BuilderBase.load_string"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.load_string">[docs]</a>    <span class="k">def</span> <span class="nf">load_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Insert a string into the Language Builder and return the root widget</span>
<span class="sd">        (if defined) of the kv string.</span>

<span class="sd">        :Parameters:</span>
<span class="sd">            `rulesonly`: bool, defaults to False</span>
<span class="sd">                If True, the Builder will raise an exception if you have a root</span>
<span class="sd">                widget inside the definition.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;rulesonly&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_filename</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># put a warning if a file is loaded multiple times</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s">&#39;Lang: The file {} is loaded multiples times, &#39;</span>
                <span class="s">&#39;you might have unwanted behaviors.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># parse the string</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">string</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

            <span class="c"># merge rules with our rules</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_matchcache</span><span class="p">()</span>

            <span class="c"># add the template found by the parser into ours</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                <span class="n">Factory</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                                 <span class="n">cls</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                                 <span class="n">is_template</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># register all the dynamic classes</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">baseclasses</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">dynamic_classes</span><span class="p">):</span>
                <span class="n">Factory</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">baseclasses</span><span class="o">=</span><span class="n">baseclasses</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span>
                                 <span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># create root object is exist</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;rulesonly&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">parser</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rulesonly&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;The file &lt;</span><span class="si">%s</span><span class="s">&gt; contain also non-rules &#39;</span>
                                <span class="s">&#39;directives&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c"># save the loaded files only if there is a root without</span>
            <span class="c"># template/dynamic classes</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">templates</span> <span class="ow">or</span>
                       <span class="n">parser</span><span class="o">.</span><span class="n">dynamic_classes</span> <span class="ow">or</span> <span class="n">parser</span><span class="o">.</span><span class="n">rules</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                <span class="n">widget</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">)()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rule</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">parser</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">widget</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_filename</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="BuilderBase.template"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.template">[docs]</a>    <span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">ctx</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a specialized template using a specific context.</span>
<span class="sd">        .. versionadded:: 1.0.5</span>

<span class="sd">        With templates, you can construct custom widgets from a kv lang</span>
<span class="sd">        definition by giving them a context. Check :ref:`Template usage</span>
<span class="sd">        &lt;template_usage&gt;`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Prevent naming clash with whatever the user might be putting into the</span>
        <span class="c"># ctx as key.</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Unknown &lt;</span><span class="si">%s</span><span class="s">&gt; template name&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">baseclasses</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">baseclasses</span><span class="p">)</span>
        <span class="n">cls</span> <span class="o">=</span> <span class="n">Cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kv.lang&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rootwidgets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">basecls</span> <span class="ow">in</span> <span class="n">baseclasses</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">):</span>
                <span class="n">rootwidgets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basecls</span><span class="p">))</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rootwidgets</span><span class="p">),</span> <span class="p">{})</span>
            <span class="n">Cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;kv.lang&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="c"># in previous versions, ``ctx`` is passed as is as ``template_ctx``</span>
        <span class="c"># preventing widgets in it from be collected by the GC. This was</span>
        <span class="c"># especially relevant to AccordionItem&#39;s title_template.</span>
        <span class="n">proxy_ctx</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">get_proxy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ctx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rule</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">template_ctx</span><span class="o">=</span><span class="n">proxy_ctx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">widget</span>
</div>
<div class="viewcode-block" id="BuilderBase.apply"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Search all the rules that match the widget and apply them.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">__debug__</span><span class="p">:</span>
            <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Builder: Found </span><span class="si">%d</span><span class="s"> rules for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">),</span> <span class="n">widget</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rules</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rule</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_clear_matchcache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">BuilderBase</span><span class="o">.</span><span class="n">_match_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_apply_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">,</span> <span class="n">template_ctx</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># widget: the current instantiated widget</span>
        <span class="c"># rule: the current rule</span>
        <span class="c"># rootrule: the current root rule (for children of a rule)</span>

        <span class="c"># will collect reference to all the id in children</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">rule</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span> <span class="o">=</span> <span class="n">rctx</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;ids&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="n">widget</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">},</span>
            <span class="s">&#39;set&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;hdl&#39;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="c"># extract the context of the rootrule (not rule!)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">rootrule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">)</span>
        <span class="n">rctx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">[</span><span class="n">rootrule</span><span class="p">]</span>

        <span class="c"># if a template context is passed, put it as &quot;ctx&quot;</span>
        <span class="k">if</span> <span class="n">template_ctx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">][</span><span class="s">&#39;ctx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">QueryDict</span><span class="p">(</span><span class="n">template_ctx</span><span class="p">)</span>

        <span class="c"># if we got an id, put it in the root rule for a later global usage</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="c"># use only the first word as `id` discard the rest.</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">widget</span><span class="o">.</span><span class="n">proxy_ref</span>
            <span class="c"># set id name as a attribute for root widget so one can in python</span>
            <span class="c"># code simply access root_widget.id_name</span>
            <span class="n">_ids</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">])</span>
            <span class="n">_root</span> <span class="o">=</span> <span class="n">_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;root&#39;</span><span class="p">)</span>
            <span class="n">_new_ids</span> <span class="o">=</span> <span class="n">_root</span><span class="o">.</span><span class="n">ids</span>
            <span class="k">for</span> <span class="n">_key</span> <span class="ow">in</span> <span class="n">iterkeys</span><span class="p">(</span><span class="n">_ids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">_ids</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">_root</span><span class="p">:</span>
                    <span class="c"># skip on self</span>
                    <span class="k">continue</span>
                <span class="n">_new_ids</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">_ids</span><span class="p">[</span><span class="n">_key</span><span class="p">]</span>
            <span class="n">_root</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">_new_ids</span>

        <span class="c"># first, ensure that the widget have all the properties used in</span>
        <span class="c"># the rule if not, they will be created as ObjectProperty.</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">create_missing</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span>

        <span class="c"># build the widget canvas</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_before</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">before</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_canvas</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">before</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span>
                                   <span class="n">rule</span><span class="o">.</span><span class="n">canvas_before</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_root</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_canvas</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span>
                                   <span class="n">rule</span><span class="o">.</span><span class="n">canvas_root</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_after</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">after</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_build_canvas</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">after</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span>
                                   <span class="n">rule</span><span class="o">.</span><span class="n">canvas_after</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">)</span>

        <span class="c"># create children tree</span>
        <span class="n">Factory_get</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">get</span>
        <span class="n">Factory_is_template</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">is_template</span>
        <span class="k">for</span> <span class="n">crule</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">crule</span><span class="o">.</span><span class="n">name</span>

            <span class="c"># depending if the child rule is a template or not, we are not</span>
            <span class="c"># having the same approach</span>
            <span class="n">cls</span> <span class="o">=</span> <span class="n">Factory_get</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">Factory_is_template</span><span class="p">(</span><span class="n">cname</span><span class="p">):</span>
                <span class="c"># we got a template, so extract all the properties and</span>
                <span class="c"># handlers, and push them in a &quot;ctx&quot; dictionary.</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">idmap</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">global_idmap</span><span class="p">)</span>
                <span class="n">idmap</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;root&#39;</span><span class="p">:</span> <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">][</span><span class="s">&#39;root&#39;</span><span class="p">]})</span>
                <span class="k">if</span> <span class="s">&#39;ctx&#39;</span> <span class="ow">in</span> <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">]:</span>
                    <span class="n">idmap</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;ctx&#39;</span><span class="p">:</span> <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">][</span><span class="s">&#39;ctx&#39;</span><span class="p">]})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">prule</span> <span class="ow">in</span> <span class="n">crule</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">prule</span><span class="o">.</span><span class="n">co_value</span>
                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CodeType</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>
                        <span class="n">ctx</span><span class="p">[</span><span class="n">prule</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">for</span> <span class="n">prule</span> <span class="ow">in</span> <span class="n">crule</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">prule</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">idmap</span><span class="p">)</span>
                        <span class="n">ctx</span><span class="p">[</span><span class="n">prule</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span>
                        <span class="n">prule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">prule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                        <span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">cause</span><span class="o">=</span><span class="n">tb</span><span class="p">)</span>

                <span class="c"># create the template with an explicit ctx</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">ctx</span><span class="p">)</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

                <span class="c"># reference it on our root rule context</span>
                <span class="k">if</span> <span class="n">crule</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">][</span><span class="n">crule</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># we got a &quot;normal&quot; rule, construct it manually</span>
                <span class="c"># we can&#39;t construct it without __no_builder=True, because the</span>
                <span class="c"># previous implementation was doing the add_widget() before</span>
                <span class="c"># apply(), and so, we could use &quot;self.parent&quot;.</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">__no_builder</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">widget</span><span class="o">.</span><span class="n">add_widget</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_rule</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">crule</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">)</span>

        <span class="c"># append the properties and handlers to our final resolution task</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">properties</span><span class="p">:</span>
            <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;set&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">widget</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span>
                                <span class="nb">list</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;hdl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">widget</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">handlers</span><span class="p">))</span>

        <span class="c"># if we are applying another rule that the root one, then it&#39;s done for</span>
        <span class="c"># us!</span>
        <span class="k">if</span> <span class="n">rootrule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">rule</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">[</span><span class="n">rule</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="c"># normally, we can apply a list of properties with a proper context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">widget_set</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">rctx</span><span class="p">[</span><span class="s">&#39;set&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">ParserRuleProperty</span><span class="p">))</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">co_value</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CodeType</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">create_handler</span><span class="p">(</span><span class="n">widget_set</span><span class="p">,</span> <span class="n">widget_set</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
                                               <span class="n">value</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">])</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">widget_set</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                                       <span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                                       <span class="n">e</span><span class="p">),</span> <span class="n">cause</span><span class="o">=</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c"># build handlers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crule</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">widget_set</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">rctx</span><span class="p">[</span><span class="s">&#39;hdl&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">crule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">crule</span><span class="p">,</span> <span class="n">ParserRuleProperty</span><span class="p">))</span>
                    <span class="k">assert</span><span class="p">(</span><span class="n">crule</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;on_&#39;</span><span class="p">))</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">crule</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">widget_set</span><span class="o">.</span><span class="n">is_event_type</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                    <span class="n">idmap</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">global_idmap</span><span class="p">)</span>
                    <span class="n">idmap</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rctx</span><span class="p">[</span><span class="s">&#39;ids&#39;</span><span class="p">])</span>
                    <span class="n">idmap</span><span class="p">[</span><span class="s">&#39;self&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">widget_set</span><span class="o">.</span><span class="n">proxy_ref</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">widget_set</span><span class="o">.</span><span class="n">fast_bind</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">custom_callback</span><span class="p">,</span> <span class="n">crule</span><span class="p">,</span>
                                                <span class="n">idmap</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="c">#hack for on_parent</span>
                    <span class="k">if</span> <span class="n">crule</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;on_parent&#39;</span><span class="p">:</span>
                        <span class="n">Factory</span><span class="o">.</span><span class="n">Widget</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">widget_set</span><span class="o">.</span><span class="n">__self__</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">crule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span>
                    <span class="n">crule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">crule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                    <span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">cause</span><span class="o">=</span><span class="n">tb</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="c"># rule finished, forget it</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">[</span><span class="n">rootrule</span><span class="p">]</span>

<div class="viewcode-block" id="BuilderBase.match"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of :class:`ParserRule` objects matching the widget.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">BuilderBase</span><span class="o">.</span><span class="n">_match_cache</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">widget</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">widget</span><span class="o">.</span><span class="n">cls</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">selector</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selector</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">widget</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">avoid_previous_rules</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">rules</span><span class="p">[:]</span>
                <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules</span>
        <span class="k">return</span> <span class="n">rules</span>
</div>
<div class="viewcode-block" id="BuilderBase.sync"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.sync">[docs]</a>    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute all the waiting operations, such as the execution of all the</span>
<span class="sd">        expressions related to the canvas.</span>

<span class="sd">        .. versionadded:: 1.7.0</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">global</span> <span class="n">_delayed_start</span>
        <span class="n">next_args</span> <span class="o">=</span> <span class="n">_delayed_start</span>
        <span class="k">if</span> <span class="n">next_args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">while</span> <span class="n">next_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="c"># is this try/except still needed? yes, in case widget died in this</span>
            <span class="c"># frame after the call was scheduled</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">call_fn</span><span class="p">(</span><span class="n">next_args</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">next_args</span>
            <span class="n">next_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">_delayed_start</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="BuilderBase.unbind_widget"><a class="viewcode-back" href="../../api-kivy.lang.html#kivy.lang.BuilderBase.unbind_widget">[docs]</a>    <span class="k">def</span> <span class="nf">unbind_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;(internal) Unbind all the handlers created by the rules of the</span>
<span class="sd">        widget. The :attr:`kivy.uix.widget.Widget.uid` is passed here</span>
<span class="sd">        instead of the widget itself, because we are using it in the</span>
<span class="sd">        widget destructor.</span>

<span class="sd">        .. versionadded:: 1.7.2</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_handlers</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">callbacks</span> <span class="ow">in</span> <span class="n">_handlers</span><span class="p">[</span><span class="n">uid</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">largs</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># it&#39;s not a kivy prop.</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">fast_unbind</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">largs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
                    <span class="c"># proxy widget is already gone, that&#39;s cool :)</span>
                    <span class="k">pass</span>
        <span class="k">del</span> <span class="n">_handlers</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_build_canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">rootrule</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">Instruction</span>
        <span class="k">if</span> <span class="n">Instruction</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Instruction</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Instruction&#39;</span><span class="p">)</span>
        <span class="n">idmap</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rulectx</span><span class="p">[</span><span class="n">rootrule</span><span class="p">][</span><span class="s">&#39;ids&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">crule</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">crule</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Clear&#39;</span><span class="p">:</span>
                <span class="n">canvas</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">instr</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">Instruction</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span>
                    <span class="n">crule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">crule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                    <span class="s">&#39;You can add only graphics Instruction in canvas.&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">prule</span> <span class="ow">in</span> <span class="n">crule</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">prule</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">prule</span><span class="o">.</span><span class="n">co_value</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="n">CodeType</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">create_handler</span><span class="p">(</span>
                            <span class="n">widget</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">proxy_ref</span><span class="p">,</span>
                            <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">prule</span><span class="p">,</span> <span class="n">idmap</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">raise</span> <span class="n">BuilderException</span><span class="p">(</span>
                    <span class="n">prule</span><span class="o">.</span><span class="n">ctx</span><span class="p">,</span> <span class="n">prule</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
                    <span class="s">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="n">cause</span><span class="o">=</span><span class="n">tb</span><span class="p">)</span>

<span class="c">#: Main instance of a :class:`BuilderBase`.</span></div>
<span class="n">Builder</span> <span class="o">=</span> <span class="n">register_context</span><span class="p">(</span><span class="s">&#39;Builder&#39;</span><span class="p">,</span> <span class="n">BuilderBase</span><span class="p">)</span>
<span class="n">Builder</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">kivy_data_dir</span><span class="p">,</span> <span class="s">&#39;style.kv&#39;</span><span class="p">),</span> <span class="n">rulesonly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">if</span> <span class="s">&#39;KIVY_PROFILE_LANG&#39;</span> <span class="ow">in</span> <span class="n">environ</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">atexit</span>
    <span class="kn">import</span> <span class="nn">cgi</span>

    <span class="k">def</span> <span class="nf">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">fn</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">prp</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">properties</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prp</span><span class="o">.</span><span class="n">line</span> <span class="o">!=</span> <span class="n">index</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">prp</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_root</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_root</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_before</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_before</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">r</span>
        <span class="k">if</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_after</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="o">.</span><span class="n">canvas_after</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">dump_builder_stats</span><span class="p">():</span>
        <span class="n">html</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;&lt;!doctype html&gt;&#39;</span>
            <span class="s">&#39;&lt;html&gt;&lt;body&gt;&#39;</span><span class="p">,</span>
            <span class="s">&#39;&lt;style type=&quot;text/css&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;pre { margin: 0; }</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;&lt;/style&gt;&#39;</span><span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">filename</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Builder</span><span class="o">.</span><span class="n">rules</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&lt;h2&gt;&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="s">&#39;&lt;/h2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;table&gt;&#39;</span><span class="p">]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">matched_prp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">psn</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">Builder</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
                    <span class="n">matched_prp</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">match_rule</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rule</span><span class="p">))</span>

                <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">matched_prp</span><span class="p">]))</span>

                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">155</span><span class="p">)</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                <span class="n">html</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&lt;tr style=&quot;background-color: rgb{}&quot;&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">color</span><span class="p">),</span>
                         <span class="s">&#39;&lt;td&gt;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="s">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
                         <span class="s">&#39;&lt;td&gt;&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">),</span> <span class="s">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
                         <span class="s">&#39;&lt;td&gt;&lt;pre&gt;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s">&#39;&lt;/pre&gt;&lt;/td&gt;&#39;</span><span class="p">,</span>
                         <span class="s">&#39;&lt;/tr&gt;&#39;</span><span class="p">]</span>
            <span class="n">html</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&lt;/table&gt;&#39;</span><span class="p">]</span>
        <span class="n">html</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;builder_stats.html&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">html</span><span class="p">))</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Profiling written at builder_stats.html&#39;</span><span class="p">)</span>

    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">dump_builder_stats</span><span class="p">)</span>
</pre></div>

            <div class="footerlinks">
              </div>
          </div>
        </div>
      </div>
      </div>
      <div class="clearer"></div>
    </div>
    </div>
<!-- Piwik --> 
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://txzone.net/piwik/" : "http://txzone.net/piwik/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 8);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://txzone.net/piwik/piwik.php?idsite=8" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->
    <!--
    <div class="footer">
      &copy; Copyright 2010, The Kivy Authors.
      Last updated on Dec 11, 2014.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b1.
</div>
-->
  </body>

<!-- Mirrored from kivy.org/docs/_modules/kivy/lang.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 13 Jan 2015 07:56:35 GMT -->
</html>